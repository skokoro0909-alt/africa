<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Africa Energy & Population Explorer</title>

  <!-- あなたのCSS（Flaskのstaticフォルダから読み込む） -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Leaflet 読み込み -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header class="header">
    <h1>Africa Energy & Population Explorer</h1>
    <p>Explore Africa's development indicators across decades</p>
    <nav><a href="/projects" class="energy-finder-btn">
           Africa Energy Research Portal →
        </a></nav>
    
      

  <div class="main-container">
    <!-- 左側のコントロールパネル -->
    <div class="controls-panel">
      <div class="box">
        <h3>Data Layer</h3>
        <select id="layer-select">
          <option value="population">Population Density</option>
          <option value="energy">Energy Access Rate</option>
        </select>
      </div>

      <div class="box">
        <h3>Year</h3>
        <input
          type="range"
          id="year-slider"
          min="1960"
          max="2050"
          value="2024"
        />
        <div id="year-display">2024</div>
      </div>
    </div>

    <!-- 右側：地図表示エリア -->
    <div id="map"></div>
  </div>

  <script>
   /* --- index.html の中にある updateMap 関数をこれに差し替えてください --- */

// 地図の上に重ねる「色の層」を保存しておく変数（入れ物）です
let geoJsonLayer;

async function updateMap(year, layerType) {
    console.log("注文を受けました！ 年:", year, " 種類:", layerType);

    try {
        // 1. Pythonの窓口 (app.py) から数値データを取ってきます
        const response = await fetch(`/api/stats?year=${year}&layer=${layerType}`);
        const statsData = await response.json();
        console.log("届いた数値データ:", statsData);

        // 2. 地図の「形（境界線）」のデータを取ってきます
        const geoResponse = await fetch('https://raw.githubusercontent.com/datasets/geo-boundaries-world-110m/master/countries.geojson');
        const geoData = await geoResponse.json();

        // 3. もし古い地図がすでに表示されていたら、一度消します（重ならないように）
        if (geoJsonLayer) {
            map.removeLayer(geoJsonLayer);
        }

        // 4. 新しい色を塗った地図を作成します
        geoJsonLayer = L.geoJson(geoData, {
            style: function(feature) {
                // 地図データの国名を取得
                let countryName = feature.properties.name;
                
                // Pythonから届いたデータの中から、その国の数値を探します
                // もし名前が微妙に違うときのために、ここを今後調整する必要があります
                let val = statsData[countryName] || 0; 

                return {
                    fillColor: getColor(val, layerType), // 下にある getColor 関数で色を決めます
                    weight: 1,
                    opacity: 1,
                    color: 'white', // 境界線の色
                    fillOpacity: 0.7 // 透明度
                };
            },
            onEachFeature: function(feature, layer) {
                // 国をクリックしたときに名前と数値を表示する設定
                let name = feature.properties.name;
                let val = statsData[name] || "データなし";
                layer.bindPopup(name + ": " + val);
            }
        }).addTo(map); // 地図に表示！

    } catch (error) {
        console.error("エラーが起きました:", error);
    }
}

// 数値に応じて色を決める「色鉛筆」のような関数
function getColor(d, type) {
    if (type === 'population') {
        return d > 200 ? '#800026' : d > 100 ? '#BD0026' : d > 50 ? '#E31A1C' : '#FFEDA0';
    } else {
        return d > 80 ? '#006837' : d > 40 ? '#78c679' : '#ffffcc';
    }
}
  </script>
</body>
</html>
