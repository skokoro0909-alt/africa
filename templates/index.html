<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Africa Energy & Population Explorer</title>

  <!-- あなたのCSS（Flaskのstaticフォルダから読み込む） -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Leaflet 読み込み -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header class="header"></header>
    <h1>Africa Energy & Population Explorer</h1>
    <p>Explore Africa's development indicators across decades</p>
    <nav><a href="/projects" class="energy-finder-btn">
           Africa Energy Research Portal →
        </a></nav>
    
      

  <div class="main-container">
    <!-- 左側のコントロールパネル -->
    <div class="controls-panel">
      <div class="box">
        <h3>Data Layer</h3>
        <select id="layer-select">
          <option value="population">Population Density</option>
          <option value="energy">Energy Access Rate</option>
        </select>
      </div>

      <div class="box">
        <h3>Year</h3>
        <input
          type="range"
          id="year-slider"
          min="1960"
          max="2050"
          value="2024"
        />
        <div id="year-display">2024</div>
      </div>
    </div>

    <!-- 右側：地図表示エリア -->
    <div id="map"></div>
  </div>

    <script>
        // 1. 地図の土台を作る
        const map = L.map("map").setView([0, 20], 3);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 6,
        }).addTo(map);

        const slider = document.getElementById("year-slider");
        const yearDisplay = document.getElementById("year-display");
        const layerSelect = document.getElementById("layer-select");

        let geoJsonLayer; // 色を塗った地図を保存する入れ物

        // 数値によって色を変える関数
        function getColor(d, type) {
            if (type === 'population') {
                return d > 100 ? '#800026' : d > 50 ? '#BD0026' : d > 20 ? '#E31A1C' : '#FFEDA0';
            } else {
                return d > 80 ? '#006837' : d > 40 ? '#78c679' : '#ffffcc';
            }
        }

        // 地図を更新するメインの命令
        async function updateMap(year, layerType) {
        try {
            // app.py の窓口 (/api/stats) から数値データを取ってくる
            const response = await fetch(`/api/stats?year=${year}&layer=${layerType}`);
            const statsData = await response.json();

            // アフリカの「形」のデータを取ってくる
            const geoResponse = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
            const geoData = await geoResponse.json();

            if (geoJsonLayer) { map.removeLayer(geoJsonLayer); }

            geoJsonLayer = L.geoJson(geoData, {
            style: function(feature) {
                const countryName = feature.properties.name;
                const val = statsData[countryName] || 0; // Pythonから届いたデータを使う
                return {
                fillColor: getColor(val, layerType),
                weight: 1, color: 'white', fillOpacity: 0.7
                };
            },
            onEachFeature: function(feature, layer) {
                const name = feature.properties.name;
                const val = statsData[name] || "データなし";
                layer.bindPopup(name + ": " + val);
            },
            // アフリカの国だけを表示
            filter: function(feature) {
                const africaList = ["Angola", "Benin", "Botswana", "Burkina Faso", "Cameroon", "Central African Republic", "Chad", "Congo", "Democratic Republic of the Congo", "Djibouti", "Egypt", "Equatorial Guinea", "Eritrea", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Ivory Coast", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali", "Mauritania", "Mauritius", "Morocco", "Mozambique", "Namibia", "Niger", "Nigeria", "Rwanda", "Senegal", "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", "Swaziland", "Tanzania", "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe"];
                return africaList.includes(feature.properties.name);
            }
            }).addTo(map);

        } catch (error) {
            console.error("エラー:", error);
        }
        }

        slider.oninput = function () {
        yearDisplay.textContent = this.value;
        updateMap(this.value, layerSelect.value);
        };

        layerSelect.onchange = function () {
        updateMap(slider.value, this.value);
        };

        // 最初に一度実行
        updateMap(2024, "population");
    </script>
</body>
</html>
